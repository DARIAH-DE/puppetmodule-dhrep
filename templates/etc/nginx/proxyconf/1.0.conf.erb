# locations for /1.0/

location /1.0/confserv/ {
#    gzip on;
    alias /var/www/confserv/1.0/;
    autoindex on;
}

location /1.0/tgrep {
    alias /var/www/nginx-root/textgridrep.de/textgridrep-webseite;
}

location /1.0/tgauth {
    proxy_pass http://localhost:8080/tgauth;
}

location /1.0/WebAuthN {
    proxy_pass http://localhost:8080/WebAuthN;
}

location /1.0/Shibboleth.sso {
    proxy_pass http://localhost:8080/1.0/Shibboleth.sso;
}

location /1.0/secure {
    proxy_pass http://localhost:8080/1.0/secure;
}

location /1.0/triplestore {
    proxy_pass http://localhost:9091/openrdf-sesame/repositories;
    limit_except GET {
       deny all;
    }
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgoaipmh {
    proxy_pass		http://localhost:9097/oaipmh;
    proxy_set_header	X-Real-IP $remote_addr;
    proxy_set_header	X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header	Host $http_host;
}

location /1.0/tgsearch {
    gzip on;
    gzip_types text/plain application/xml;
    proxy_pass http://localhost:9090/tgsearch;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgsearch-public {
    gzip on;
    gzip_types text/plain application/xml;
    proxy_pass http://localhost:9090/tgsearch-public;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgcrud {
#    gzip on;
#    gzip_types multipart/related application/xop+xml text/xml;
    client_max_body_size 1000m;
    proxy_read_timeout 900s;
    proxy_send_timeout 900s;
    proxy_connect_timeout 120s;
    proxy_pass http://localhost:9093/tgcrud;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgcrud-public {
#    gzip on;
#    gzip_types multipart/related application/xop+xml text/xml;
    client_max_body_size 1000m;
    proxy_read_timeout 900s;
    proxy_send_timeout 900s;
    proxy_connect_timeout 120s;
    proxy_pass http://localhost:9094/tgcrud-public;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgpublish {
    proxy_pass http://localhost:9094/tgpublish;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgpid {
    proxy_pass http://localhost:9094/tgpid;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/digilib {
    proxy_pass http://localhost:9092/digilibservice;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/digilib/rest/IIIF {
    proxy_pass http://localhost:9092/digilibservice/rest/IIIF;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
    proxy_cache digilib_iiif;
    proxy_cache_valid 48h;
}

location /1.0/iiif/manifests {
    gzip on;
    gzip_types text/plain application/json;
    proxy_pass http://localhost:9092/iiifmd;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/iiif/mirador {
    alias /var/www/nginx-root/textgridrep.de/iiif/mirador;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/iiif/m2 {
    alias /var/www/nginx-root/textgridrep.de/iiif/m2;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}


location /1.0/aggregator {
    proxy_read_timeout 900s;
    proxy_send_timeout 900s;
    proxy_connect_timeout 120s;
    proxy_pass http://localhost:9095/aggregator;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host localhost:9095;
#    proxy_set_header Host $http_host;
}

location /1.0/aggregator/html {
    proxy_read_timeout 900s;
    proxy_send_timeout 900s;
    proxy_connect_timeout 120s;
    proxy_pass http://localhost:9095/aggregator/html;

    # cache aggregator html for 10 years ;-)
    proxy_cache aggregator;
    proxy_cache_valid 10y;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host localhost:9095;
#    proxy_set_header Host $http_host;
}

location /1.0/tgsearch-public/navigation/toplevel  {
#    expires 24h;
    expires <%= scope.lookupvar('dhrep::tgnginx::tgsearch_toplevel_cache_expiration') %>;
    gzip on;
    gzip_types text/plain application/xml;
    proxy_cache tgsearch;
    proxy_cache_valid 24h;
    proxy_pass http://localhost:9090/tgsearch-public/navigation/toplevel;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /marketplace {
    proxy_pass http://localhost:8080/marketplace;
}

location /tgnsearch {
    proxy_pass http://ref.dariah.eu/tgnsearch;
}

location /pndsearch {
    proxy_pass http://ref.dariah.eu/pndsearch;
}

location /voyant {
    proxy_pass http://voyant.de.dariah.eu/voyant;
}


# rewrite /textgrid: and /hdl: uris, so they are served by tgcrud
rewrite ^/(textgrid:[a-z0-9\.]+)$ /1.0/tgcrud-public/rest/$1/data last;
rewrite ^/(textgrid:[a-z0-9\.]+)/data$ /1.0/tgcrud-public/rest/$1/data last;
rewrite ^/(textgrid:[a-z0-9\.]+)/metadata$ /1.0/tgcrud-public/rest/$1/metadata last;
rewrite ^/(hdl:(11858|11378|11022)/[a-z0-9A-Z\-]+)$ /1.0/tgcrud/rest/$1/data last;
rewrite ^/(hdl:(11858|11378|11022)/[a-z0-9A-Z\-]+)/data$ /1.0/tgcrud/rest/$1/data last;
rewrite ^/(hdl:(11858|11378|11022)/[a-z0-9A-Z\-]+)/metadata$ /1.0/tgcrud/rest/$1/metadata last;
rewrite_log on;
