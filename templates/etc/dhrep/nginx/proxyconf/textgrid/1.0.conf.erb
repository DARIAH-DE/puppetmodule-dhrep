# locations for /1.0/

location /1.0/confserv/ {
#    gzip on;
    alias /var/www/confserv/1.0/;
    autoindex on;
}

location /1.0/tgrep {
    alias /var/www/nginx-root/textgridrep.de/textgridrep-webseite;
}

location /1.0/tgauth {
    proxy_pass http://localhost:8080/tgauth;
}

location /1.0/WebAuthN {
    proxy_pass http://localhost:8080/WebAuthN;
}

location /1.0/Shibboleth.sso {
    proxy_pass http://localhost:8080/1.0/Shibboleth.sso;
}

location /1.0/secure {
    proxy_pass http://localhost:8080/1.0/secure;
}

location /1.0/triplestore {
    proxy_pass http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_sesame::http_port') %>/openrdf-sesame/repositories;
    limit_except GET {
       deny all;
    }
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgoaipmh {
    proxy_pass		http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_oaipmh::http_port') %>/oaipmh;
    proxy_set_header	X-Real-IP $remote_addr;
    proxy_set_header	X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header	Host $http_host;
}

location /1.0/tgsearch {
    gzip on;
    gzip_types text/plain application/xml;
    proxy_pass http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_tgsearch::http_port') %>/tgsearch;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgsearch-public {
    gzip on;
    gzip_types text/plain application/xml;
    proxy_pass http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_tgsearch::http_port') %>/tgsearch-public;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgcrud {
#    gzip on;
#    gzip_types multipart/related application/xop+xml text/xml;
    client_max_body_size 1000m;
    proxy_read_timeout 900s;
    proxy_send_timeout 900s;
    proxy_connect_timeout 120s;
    proxy_pass http://localhost:<%= @tomcat_crud_http_port %>/tgcrud;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgcrud-public {
#    gzip on;
#    gzip_types multipart/related application/xop+xml text/xml;
    client_max_body_size 1000m;
    proxy_read_timeout 900s;
    proxy_send_timeout 900s;
    proxy_connect_timeout 120s;
    proxy_pass http://localhost:<%= @tomcat_crud_http_port %>/tgcrud-public;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/tgpublish {
    proxy_pass http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_publish::http_port') %>/tgpublish;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
#    add_header              Access-Control-Allow-Origin *;
}

location /1.0/tgpid {
    proxy_pass http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_publish::http_port') %>/tgpid;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/digilib {
    proxy_pass http://digilib_balancer/digilibservice;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/digilib/rest/IIIF {
    proxy_pass http://digilib_balancer/digilibservice/rest/IIIF;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
    proxy_cache digilib_iiif;
    proxy_cache_valid 48h;
}

location /1.0/iiif/manifests {
    gzip on;
    gzip_types text/plain application/json;
    proxy_pass http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_digilib::http_port') %>/iiifmd;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/iiif/mirador {
    alias /var/www/nginx-root/textgridrep.de/iiif/mirador;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/iiif/m2 {
    alias /var/www/nginx-root/textgridrep.de/iiif/m2;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /1.0/aggregator {
    proxy_read_timeout 900s;
    proxy_send_timeout 900s;
    proxy_connect_timeout 120s;
    proxy_pass http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_aggregator::http_port') %>/aggregator;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host localhost:<%= scope.lookupvar('dhrep::services::tomcat_aggregator::http_port') %>;
}

location /1.0/aggregator/html {
    proxy_read_timeout 900s;
    proxy_send_timeout 900s;
    proxy_connect_timeout 120s;
    proxy_pass http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_aggregator::http_port') %>/aggregator/html;
    # cache aggregator html for 10 years ;-)
    proxy_cache aggregator;
    proxy_cache_valid 10y;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host localhost:<%= scope.lookupvar('dhrep::services::tomcat_aggregator::http_port') %>;
}

location /1.0/tgsearch-public/navigation/toplevel  {
    expires <%= scope.lookupvar('dhrep::nginx::tgsearch_toplevel_cache_expiration') %>;
    gzip on;
    gzip_types text/plain application/xml;
    proxy_cache tgsearch;
    proxy_cache_valid 24h;
    proxy_pass http://localhost:<%= scope.lookupvar('dhrep::services::tomcat_tgsearch::http_port') %>/tgsearch-public/navigation/toplevel;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
}

location /marketplace {
    proxy_pass http://localhost:8080/marketplace;
}

location /tgnsearch {
    proxy_pass http://ref.dariah.eu/tgnsearch;
}

location /pndsearch {
    proxy_pass http://ref.dariah.eu/pndsearch;
}

location /voyant {
    proxy_pass http://voyant.de.dariah.eu/voyant;
}

location /voyant2 {
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        Host $http_host;
    proxy_pass http://voyant.de.dariah.eu/voyant2;
}

# rewrite /textgrid: and /hdl: uris, so they are served by tgcrud
rewrite ^/(textgrid:[a-z0-9\.]+)$ /1.0/tgcrud-public/rest/$1/data last;
rewrite ^/(textgrid:[a-z0-9\.]+)/data$ /1.0/tgcrud-public/rest/$1/data last;
rewrite ^/(textgrid:[a-z0-9\.]+)/metadata$ /1.0/tgcrud-public/rest/$1/metadata last;
rewrite ^/(hdl:(11858|11378|11022)/[a-z0-9A-Z\-]+)$ /1.0/tgcrud/rest/$1/data last;
rewrite ^/(hdl:(11858|11378|11022)/[a-z0-9A-Z\-]+)/data$ /1.0/tgcrud/rest/$1/data last;
rewrite ^/(hdl:(11858|11378|11022)/[a-z0-9A-Z\-]+)/metadata$ /1.0/tgcrud/rest/$1/metadata last;
rewrite_log on;
